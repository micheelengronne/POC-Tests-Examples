Vagrant.configure("2") do |config|

  config.vm.define "metasploitable" do |metasploitable|
    # DVWA Default credentials:
    # login:      admin
    # password:   password

    metasploitable.vm.box = "daniele2010/Metasploitable2"
    metasploitable.ssh.username = "msfadmin"
    metasploitable.ssh.password = "msfadmin"
    metasploitable.vm.synced_folder ".", "/vagrant", disabled: true
    metasploitable.vm.network "private_network", ip: "192.168.50.4", virtualbox__intnet: "pentest"

    # VirtualBox specific settings
    metasploitable.vm.provider "virtualbox" do |vb|
      vb.gui = true
      vb.customize ['setextradata', :id, 'GUI/ScaleFactor', '2.00']
      vb.memory = 4096
    end
  end

  config.vm.define "kali" do |kali|
    # Default credentials:
    # login:      vagrant
    # password:   vagrant

    # If the IP is not set, do
    #   vagrant ssh kali
    #   sudo ifconfig eth1 192.168.50.3 netmask 255.255.255.0 up

    # To pass the keyboard to french, do
    #   setxkbmap fr

    $script = <<-SCRIPT
    echo Setting the IP that Kali refuses to set by default
    sudo ifconfig eth1 192.168.50.3 netmask 255.255.255.0 up
    SCRIPT

    $script2 = <<-SCRIPT
    echo '-----------------------------------------------------------------------------------------------------'
    echo Install nmap scanner extensions
    echo '-----------------------------------------------------------------------------------------------------'
    cd /usr/local/src
    sudo git clone https://github.com/scipag/vulscan scipag_vulscan
    sudo ln -s `pwd`/scipag_vulscan /usr/share/nmap/scripts/vulscan
    sudo git clone https://github.com/vulnersCom/nmap-vulners.git
    sudo cp nmap-vulners/vulners.nse /usr/share/nmap/scripts/vulners.nse
    sudo nmap --script-updatedb
    SCRIPT

    $script3 = <<-SCRIPT
    echo '-----------------------------------------------------------------------------------------------------'
    echo Install metasploit-framework and seclists
    echo '-----------------------------------------------------------------------------------------------------'
    sudo apt-get update
    #sudo apt-get purge metasploit-framework seclists -y --autoremove
    #sudo apt-get install metasploit-framework seclists -y
    echo Install sendmail to test phishing
    sudo apt-get install sendmail -y
    SCRIPT

    $script4 = <<-SCRIPT
    echo '-----------------------------------------------------------------------------------------------------'
    echo Upgrade
    echo '-----------------------------------------------------------------------------------------------------'
    sudo apt-get update
    sudo echo "set grub-pc/install_devices /dev/sda" | debconf-communicate
    #sudo apt-get upgrade -y
    #sudo apt-get dist-upgrade -y
    SCRIPT

    $script5 = <<-SCRIPT
    echo '-----------------------------------------------------------------------------------------------------'
    echo Install gvm, that substitutes openvas
    echo '-----------------------------------------------------------------------------------------------------'
    sudo apt-get update
    sudo apt-get install gvm -y
    sudo gvm-setup
    sudo gvm-check-setup
    sudo ospd-openvas
    #sudo gvm-start
    SCRIPT

    kali.vm.box = "kalilinux/rolling"
    kali.vm.network "private_network", ip: "192.168.50.3", virtualbox__intnet: "pentest"

    # VirtualBox specific settings
    kali.vm.provider "virtualbox" do |vb|
      vb.gui = true
      vb.customize ['setextradata', :id, 'GUI/ScaleFactor', '2.00']

      # Customize the amount of memory on the VM:
      vb.memory = "4096"
    end

    kali.vm.provision "shell", inline: $script
    unless ENV['PENTESTLAB_NMAP'] == 'no'
      kali.vm.provision "shell", inline: $script2
    end
    unless ENV['PENTESTLAB_METASPLOIT'] == 'no'
      kali.vm.provision "shell", inline: $script3
    end
    unless ENV['PENTESTLAB_UPGRADE'] == 'no'
      kali.vm.provision "shell", inline: $script4
    end
    unless ENV['PENTESTLAB_OPENVAS'] == 'no'
      kali.vm.provision "shell", inline: $script5
    end
  end
end
